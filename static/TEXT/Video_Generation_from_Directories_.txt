Video Generation from Directories.
user
directories = ["static/screaming","static/abstract_beauty","static/uploads","static/experiment","static/energy_crystal"]

@app.route('/choose_dir', methods=['GET', 'POST'])
def choose_dir():
    if request.method == 'POST':
        selected_directory = request.form.get('directory', directories)
        if selected_directory is None:
            # Handle the case where no directory is selected
            return 'No directory selected!'
        
        # rest of the code...
        selected_directory = request.args.get('directory')
        print('selected_directory:', selected_directory)
        print('request URL:', request.url)
     
        # Get the list of image files in the selected directory
        image_filenames = random.sample(glob.glob(selected_directory + '/*.jpg'),30)
        image_clips = []
        for filename in image_filenames:
            # Open the image file and resize it to 512x768
            image = Image.open(filename)
            image = image.resize((512, 768), Image.ANTIALIAS)
            print(image)
            # Convert the PIL Image object to a NumPy array
            image_array = np.array(image)
            # Create an ImageClip object from the resized image and set its duration to 1 second
            image_clip = ImageClip(image_array).set_duration(1)
        
            # Append the image clip to the list
            image_clips.append(image_clip)
    
        # Concatenate all the image clips into a single video clip
        video_clip = concatenate_videoclips(image_clips, method='compose')
        timestr = time.strftime("%Y%m%d-%H%M%S")
        # Set the fps value for the video clip
        video_clip.fps = 24
        # Write the video clip to a file
        video_file = 'static/videos/random_images'+timestr+'Xvideo.mp4'
        output_p = 'static/videos/random_images_video.mp4'
        video_clip.write_videofile(video_file, fps=24)
        try:
            shutil.copy(video_file, output_p)
        except FileNotFoundError as e:
            logging.error("Error occurred while copying file: %s", str(e))

        # Return a message to the client
        return 'Video generated successfully!'

    output_p = 'static/videos/random_images_video.mp4'
    # If the request method is GET, render the form template with the list of directories
    return render_template('choose_dir.html', directories=directories, output_path=output_p)

ChatGPT
The provided code is a Flask web application that allows the user to select a directory from a list of directories and generates a video from a random selection of images found in the chosen directory.

Let's break down the code and understand its functionality step by step:

1. `directories`: This is a list that contains paths to various directories that are meant to store image files.

2. `@app.route('/choose_dir', methods=['GET', 'POST'])`: This is a route decorator for the `/choose_dir` URL. It specifies that the function `choose_dir()` will handle both GET and POST requests made to this URL.

3. `def choose_dir():`: This is the main function that will be executed when a request is made to the `/choose_dir` URL.

4. `if request.method == 'POST':`: This block of code checks if the request method is POST, which means the user has submitted the form on the webpage.

5. `selected_directory = request.form.get('directory', directories)`: This line attempts to get the value of the 'directory' key from the form submitted by the user. If the key is not found in the form data, it defaults to the `directories` list, which contains the paths to directories.

6. `if selected_directory is None:`: This checks if no directory is selected by the user, and if so, it returns the message 'No directory selected!' to the client.

7. `selected_directory = request.args.get('directory')`: This line gets the value of the 'directory' key from the request arguments. However, this line is redundant since the value of `selected_directory` has already been obtained in the previous step using `request.form.get()`.

8. The code then proceeds to read image files from the selected directory, resize them, and convert them into video clips using the `moviepy` library. The video clip is then saved as a .mp4 file.

9. `render_template('choose_dir.html', directories=directories, output_path=output_p)`: If the request method is GET (when the user first accesses the page), this line renders an HTML template called 'choose_dir.html' and passes the `directories` list and the `output_p` variable to the template.

Overall, the web application allows users to select a directory from a list, generates a video from randomly selected images in the chosen directory, and provides feedback on the successful generation of the video. If no directory is selected, it will display an error message indicating that no directory has been selected.

However, a few points to note:

1. The code provided doesn't show the entire Flask application setup, so make sure that the Flask app is properly initialized with `app = Flask(__name__)`.

2. Ensure that all the necessary imports are present (e.g., Flask, request, render_template, Image, np, concatenate_videoclips, etc.).

3. Verify that the necessary HTML template `choose_dir.html` is created, which will be used to render the form for directory selection.

4. The code uses the `glob` module to find image files with the extension `.jpg` in the selected directory. Make sure that the image files in the specified directories have the `.jpg` extension.

5. The `shutil` module is used for copying the generated video file. Ensure that the necessary permissions and directories are set for copying the file successfully.

6. Make sure to install the required libraries, such as `Flask`, `moviepy`, `PIL`, `numpy`, etc., in your environment.

Remember to test the application to ensure it works as expected in your development environment.
user
Could I see an example of choose_dir.html
ChatGPT
Sure! Below is an example of a simple `choose_dir.html` template for the Flask web application:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Choose Directory</title>
</head>
<body>
    <h1>Choose a Directory</h1>
    <form method="post" action="/choose_dir">
        <label for="directory">Select a Directory:</label>
        <select name="directory" id="directory">
            {% for dir in directories %}
                <option value="{{ dir }}">{{ dir }}</option>
            {% endfor %}
        </select>
        <br>
        <input type="submit" value="Generate Video">
    </form>
    {% if output_path %}
        <p>{{ output_path }}</p>
        <p>Video generated successfully!</p>
        <video width="512" height="768" controls>
            <source src="{{ output_path }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    {% endif %}
</body>
</html>
```

In this example, the HTML template contains a form with a dropdown menu (`select` element) that allows the user to choose a directory from the list of directories (`directories`) passed from the Flask view function. The form has a submit button (`input type="submit"`) that triggers the video generation when clicked.

If the video has been generated successfully (indicated by the `output_path` variable being available), the template will display the video player along with a success message.

Note that this is just a basic example. Depending on your specific needs, you can customize the HTML template further with additional styling, error handling, or other features as required.
user
from flask import Flask, render_template, request
import os
import subprocess
import shutil
import datetime
import logging
import random
from PIL import Image
import glob
import time
from flask import Flask, render_template, request, redirect, url_for, send_from_directory, Response,flash
from flask import send_file, make_response,g
import os
import pygame
from gtts import gTTS
import time
import numpy as np
from random import randint
from moviepy.editor import VideoFileClip, ImageClip, CompositeVideoClip
from moviepy.editor import concatenate_videoclips, AudioFileClip, TextClip
import moviepy.editor
import subprocess 
import shutil  



# Create a logging object
logging.basicConfig(filename='myapp.log', level=logging.DEBUG, format='%(asctime)s %(levelname)s: %(message)s')

app = Flask(__name__, static_folder='static')


@app.route('/')
def index():
    return render_template('index.html')
@app.route('/add_effects')
def add_effects():
    return '''
        <form method="post" action="/video" enctype="multipart/form-data">
            <label for="input_video">Select input video file:</label><br>
            <input type="file" id="input_video" name="input_video"><br><br>
            <input type="submit" value="Submit">
        </form>
    '''   

@app.route('/video', methods=['POST','GET'])
def process_videos():
    DIR = "static/"
    input_video = request.files['input_video']
    ""
    # Save the uploaded video to a file
    input_video.save(f"{DIR}input_video2.mp4")
    
    command1 = f"ffmpeg -nostdin -i {DIR}input_video2.mp4 -filter:v \"minterpolate='mi_mode=mci:mc_mode=aobmc:vsbmc=1:fps=10'\" -c:v libx264 -r 20 -pix_fmt yuv420p -c:a copy -y {DIR}alice/output2.mp4"    
    subprocess.run(command1, shell=True, stderr=subprocess.PIPE, universal_newlines=True)
    
    command2 = f"ffmpeg -hide_banner -i {DIR}alice/output2.mp4 -filter:v \"setpts=5*PTS,minterpolate='fps=25:scd=none:me_mode=bidir:vsbmc=1:search_param=200'\" -t 58 -y {DIR}alice/final2.mp4"
    subprocess.run(command2, shell=True, stderr=subprocess.PIPE, universal_newlines=True)
    
    command3 = f"ffmpeg -hide_banner -i {DIR}alice/final2.mp4 -filter:v \"setpts=5*PTS,minterpolate='fps=25:scd=none:me_mode=bidir:vsbmc=1:search_param=200'\" -t 58 -y {DIR}alice/final5.mp4"
    subprocess.run(command3, shell=True, stderr=subprocess.PIPE, universal_newlines=True)

    # Add music to the video
    init = randint(10,50)
    MUSIC=["static/music/Born_a_Rockstar-Instrumental-NEFFEX.mp3","static/music/Cattle-Telecasted.mp3","static/music/Bite_Me-Clean-NEFFEX.mp3","static/music/El_Secreto-Yung_Logos.mp3","static/music/Blue_Mood-Robert_Munzinger.mp3","static/music/Escapism-Yung_Logos.mp3","static/music/Enough-NEFFEX.mp3","static/music/As_You_Fade_Away-NEFFEX.mp3","static/music/Culture-Anno_Domini_Beats.mp3","static/music/Contrast-Anno_Domini_Beats.mp3","static/music/Diving_in_Backwards-Nathan_Moore.mp3","static/music/Aztec_Empire-Jimena_Contreras.mp3","static/music/Devil_s_Organ-Jimena_Contreras.mp3","static/music/Alpha_Mission-Jimena_Contreras.mp3","static/music/Changing-NEFFEX.mp3","static/music/Anxiety-NEFFEX.mp3","static/music/6-Shots-NEFFEX.mp3","static/music/DimishedReturns.mp3","static/music/Drum_Meditation.mp3","static/music/ChrisHaugen.mp3","static/music/DoveLove-Moreira.mp3","static/music/DesertPlanet.mp3","static/music/David_Fesliyan.mp3"]
    
    music = random.choice(MUSIC)
    command3 = f"ffmpeg -i {DIR}alice/final5.mp4 -ss {init} -i {music} -af 'afade=in:st=0:d=4,afade=out:st=55:d=3' -map 0:0 -map 1:0 -shortest -y {DIR}alice/Final_End.mp4"
    subprocess.run(command3, shell=True)
    
    # Save the output video to a file   
    now = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    shutil.copy(f"{DIR}alice/output2.mp4", f"{DIR}alice/{now}_output.mp4")
    shutil.copy(f"{DIR}alice/Final_End.mp4", f"{DIR}alice/{now}_Final.mp4")
    shutil.copy(f"{DIR}alice/Final_End.mp4", f"{DIR}alice/Final_End_mix.mp4")
    return render_template('final.html', video_file="alice/Final_End.mp4")

directories = ["static/screaming","static/abstract_beauty","static/uploads","static/experiment","static/energy_crystal"]

@app.route('/choose_dir', methods=['GET', 'POST'])
def choose_dir():
    if request.method == 'POST':
        selected_directory = request.form.get('directory', directories)
        if selected_directory is None:
            # Handle the case where no directory is selected
            return 'No directory selected!'
        
        # rest of the code...
        selected_directory = request.args.get('directory')
        print('selected_directory:', selected_directory)
        print('request URL:', request.url)
     
        # Get the list of image files in the selected directory
        image_filenames = random.sample(glob.glob(selected_directory + '/*.jpg'),30)
        image_clips = []
        for filename in image_filenames:
            # Open the image file and resize it to 512x768
            image = Image.open(filename)
            image = image.resize((512, 768), Image.ANTIALIAS)
            print(image)
            # Convert the PIL Image object to a NumPy array
            image_array = np.array(image)
            # Create an ImageClip object from the resized image and set its duration to 1 second
            image_clip = ImageClip(image_array).set_duration(1)
        
            # Append the image clip to the list
            image_clips.append(image_clip)
    
        # Concatenate all the image clips into a single video clip
        video_clip = concatenate_videoclips(image_clips, method='compose')
        timestr = time.strftime("%Y%m%d-%H%M%S")
        # Set the fps value for the video clip
        video_clip.fps = 24
        # Write the video clip to a file
        video_file = 'static/videos/random_images'+timestr+'Xvideo.mp4'
        output_p = 'static/videos/random_images_video.mp4'
        video_clip.write_videofile(video_file, fps=24)
        try:
            shutil.copy(video_file, output_p)
        except FileNotFoundError as e:
            logging.error("Error occurred while copying file: %s", str(e))

        # Return a message to the client
        return 'Video generated successfully!'

    output_p = 'static/videos/random_images_video.mp4'
    # If the request method is GET, render the form template with the list of directories
    return render_template('choose_dir.html', directories=directories, output_path=output_p)

if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5100))
    app.run(debug=True, host='0.0.0.0', port=port)
Problrm: Someting is not working right when I choose_dir
ChatGPT
Based on the provided code, it seems that there are two different routes for generating videos: `/video` and `/choose_dir`. Let's address the issue where something is not working correctly in the `/choose_dir` route.

Upon reviewing the code, it appears that the `/choose_dir` route is meant to allow the user to select a directory and generate a video from a random selection of images in that directory. However, there are a couple of issues with the current implementation:

1. Incorrect form submission method: The form in the `choose_dir.html` template is missing the correct form submission method. By default, a form uses the GET method when no method is specified. However, in the Flask route `choose_dir()`, it is expecting a POST request. To fix this, we need to explicitly set the form method to POST in the `choose_dir.html` template.

2. Missing form action attribute: The form in the `choose_dir.html` template is missing the `action` attribute, which specifies the URL to submit the form data. The action attribute should be set to the `/choose_dir` URL.

Let's modify the `choose_dir.html` template to fix these issues:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Choose Directory</title>
</head>
<body>
    <h1>Choose a Directory</h1>
    <form method="post" action="/choose_dir">
        <label for="directory">Select a Directory:</label>
        <select name="directory" id="directory">
            {% for dir in directories %}
                <option value="{{ dir }}">{{ dir }}</option>
            {% endfor %}
        </select>
        <br>
        <input type="submit" value="Generate Video">
    </form>
    {% if output_path %}
        <p>{{ output_path }}</p>
        <p>Video generated successfully!</p>
        <video width="512" height="768" controls>
            <source src="{{ output_path }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    {% endif %}
</body>
</html>
```

With these changes, the form should now submit its data to the `/choose_dir` route using the POST method when the "Generate Video" button is clicked. This should trigger the video generation process and display the generated video in the template when it's done.

Additionally, please make sure to check the console logs and server logs for any error messages or unexpected behavior that might help identify the issue further. If the problem persists, please provide more details about the specific issue or error message you encounter so that I can better assist you in resolving it.
user
<!DOCTYPE html>
<html>
<head>
    <title>Choose Directory</title>
</head>
<body>
    <h1>Choose a Directory</h1>
    <form method="post" action="/choose_dir">
        <label for="directory">Select a Directory:</label>
        <select name="directory" id="directory">
            {% for dir in directories %}
                <option value="{{ dir }}">{{ dir }}</option>
            {% endfor %}
        </select>
        <br>
        <input type="submit" value="Generate Video">
    </form>
    {% if output_path %}
        <p>{{ output_path }}</p>
        <p>Video generated successfully!</p>
        <video width="512" height="768" controls>
            <source src="{{ output_path }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    {% endif %}
</body>
</html>
--------------------- log                          2023-07-22 09:52:00,526 INFO: 127.0.0.1 - - [22/Jul/2023 09:52:00] "[33mGET /favicon.ico HTTP/1.1[0m" 404 -
2023-07-22 09:52:06,136 DEBUG: selected_directory: static/screaming
2023-07-22 09:52:06,138 DEBUG: SELECTED_DIRECTORY: None
2023-07-22 09:52:06,144 INFO: 127.0.0.1 - - [22/Jul/2023 09:52:06] "[35m[1mPOST /choose_dir HTTP/1.1[0m" 500 -
2023-07-22 09:52:06,301 INFO: 127.0.0.1 - - [22/Jul/2023 09:52:06] "[36mGET /choose_dir?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2023-07-22 09:52:06,302 INFO: 127.0.0.1 - - [22/Jul/2023 09:52:06] "[36mGET /choose_dir?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2023-07-22 09:52:06,312 INFO: 127.0.0.1 - - [22/Jul/2023 09:52:06] "[36mGET /choose_dir?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -

ChatGPT
Based on the provided log and code, it seems that there is an issue with the `selected_directory` variable in the `/choose_dir` route. The variable `selected_directory` is being assigned correctly, but then it gets overridden with `None` in the subsequent line.

To fix the issue, we can remove the redundant line that sets `selected_directory` to `None`. Additionally, we can remove the unnecessary `print` statements for better code clarity.

Here's the modified `/choose_dir` route:

```python
@app.route('/choose_dir', methods=['GET', 'POST'])
def choose_dir():
    if request.method == 'POST':
        selected_directory = request.form.get('directory')
        if selected_directory is None:
            # Handle the case where no directory is selected
            return 'No directory selected!'
        
        print('selected_directory:', selected_directory)
     
        # Get the list of image files in the selected directory
        image_filenames = random.sample(glob.glob(selected_directory + '/*.jpg'), 30)
        image_clips = []
        for filename in image_filenames:
            # Open the image file and resize it to 512x768
            image = Image.open(filename)
            image = image.resize((512, 768), Image.ANTIALIAS)
            # Convert the PIL Image object to a NumPy array
            image_array = np.array(image)
            # Create an ImageClip object from the resized image and set its duration to 1 second
            image_clip = ImageClip(image_array).set_duration(1)
        
            # Append the image clip to the list
            image_clips.append(image_clip)
    
        # Concatenate all the image clips into a single video clip
        video_clip = concatenate_videoclips(image_clips, method='compose')
        timestr = time.strftime("%Y%m%d-%H%M%S")
        # Set the fps value for the video clip
        video_clip.fps = 24
        # Write the video clip to a file
        video_file = 'static/videos/random_images' + timestr + 'Xvideo.mp4'
        output_p = 'static/videos/random_images_video.mp4'
        video_clip.write_videofile(video_file, fps=24)
        try:
            shutil.copy(video_file, output_p)
        except FileNotFoundError as e:
            logging.error("Error occurred while copying file: %s", str(e))

        # Return a message to the client
        return 'Video generated successfully!'

    output_p = 'static/videos/random_images_video.mp4'
    # If the request method is GET, render the form template with the list of directories
    return render_template('choose_dir.html', directories=directories, output_path=output_p)
```

Make sure you've made these changes to the `/choose_dir` route in your Flask application, and the issue with `selected_directory` being overridden by `None` should be resolved. Additionally, ensure that the `directories` variable is defined correctly with valid paths to the image directories.
user
Can you modify this instead I have logging in it ----------------------@app.route('/choose_dir', methods=['GET', 'POST'])
def choose_dir():
    if request.method == 'POST':
        selected_directory = request.form.get('directory', directories)
        logging.debug("selected_directory: %s", selected_directory)
        if selected_directory is None:
            # Handle the case where no directory is selected
            return 'No directory selected!'
        
        # rest of the code...
        selected_directory = request.args.get('directory')
        print('selected_directory:', selected_directory)
        print('request URL:', request.url)
     
        # Get the list of image files in the selected directory
        logging.debug("SELECTED_DIRECTORY: %s", selected_directory)
        image_filenames = random.sample(glob.glob(selected_directory + '/*.jpg'),30)
        logging.error("image_filenames: %s", image_filenames)
        image_clips = []
        for filename in image_filenames:
            # Open the image file and resize it to 512x768
            image = Image.open(filename)
            image = image.resize((512, 768), Image.ANTIALIAS)
            print(image)
            # Convert the PIL Image object to a NumPy array
            image_array = np.array(image)
            # Create an ImageClip object from the resized image and set its duration to 1 second
            image_clip = ImageClip(image_array).set_duration(1)
        
            # Append the image clip to the list
            image_clips.append(image_clip)
    
        # Concatenate all the image clips into a single video clip
        video_clip = concatenate_videoclips(image_clips, method='compose')
        timestr = time.strftime("%Y%m%d-%H%M%S")
        # Set the fps value for the video clip
        video_clip.fps = 24
        # Write the video clip to a file
        video_file = 'static/videos/random_images'+timestr+'Xvideo.mp4'
        output_p = 'static/videos/random_images_video.mp4'
        video_clip.write_videofile(video_file, fps=24)
        try:
            shutil.copy(video_file, output_p)
        except FileNotFoundError as e:
            logging.error("Error occurred while copying file: %s", str(e))

        # Return a message to the client
        return 'Video generated successfully!'

    output_p = 'static/videos/random_images_video.mp4'
    # If the request method is GET, render the form template with the list of directories
    return render_template('choose_dir.html', directories=directories, output_path=output_p)

ChatGPT
Sure, I've modified the code as per your request, adding logging statements instead of print statements. Additionally, I've fixed the issue with `selected_directory` being overridden by `None`. Here's the updated code:

```python
import logging

# Your existing code...

# Create a logging object
logging.basicConfig(filename='myapp.log', level=logging.DEBUG, format='%(asctime)s %(levelname)s: %(message)s')

# Your existing code...

@app.route('/choose_dir', methods=['GET', 'POST'])
def choose_dir():
    if request.method == 'POST':
        selected_directory = request.form.get('directory')
        logging.debug("selected_directory: %s", selected_directory)
        if selected_directory is None:
            # Handle the case where no directory is selected
            logging.error("No directory selected!")
            return 'No directory selected!'
        
        # Get the list of image files in the selected directory
        logging.debug("SELECTED_DIRECTORY: %s", selected_directory)
        image_filenames = random.sample(glob.glob(selected_directory + '/*.jpg'), 30)
        logging.error("image_filenames: %s", image_filenames)
        image_clips = []
        for filename in image_filenames:
            # Open the image file and resize it to 512x768
            image = Image.open(filename)
            image = image.resize((512, 768), Image.ANTIALIAS)
            # Convert the PIL Image object to a NumPy array
            image_array = np.array(image)
            # Create an ImageClip object from the resized image and set its duration to 1 second
            image_clip = ImageClip(image_array).set_duration(1)
        
            # Append the image clip to the list
            image_clips.append(image_clip)
    
        # Concatenate all the image clips into a single video clip
        video_clip = concatenate_videoclips(image_clips, method='compose')
        timestr = time.strftime("%Y%m%d-%H%M%S")
        # Set the fps value for the video clip
        video_clip.fps = 24
        # Write the video clip to a file
        video_file = 'static/videos/random_images' + timestr + 'Xvideo.mp4'
        output_p = 'static/videos/random_images_video.mp4'
        video_clip.write_videofile(video_file, fps=24)
        try:
            shutil.copy(video_file, output_p)
        except FileNotFoundError as e:
            logging.error("Error occurred while copying file: %s", str(e))

        # Return a message to the client
        return 'Video generated successfully!'

    output_p = 'static/videos/random_images_video.mp4'
    # If the request method is GET, render the form template with the list of directories
    return render_template('choose_dir.html', directories=directories, output_path=output_p)

# Your existing code...
```

With these changes, the code will use the `logging` module to record log messages instead of print statements. The logs will be written to the file specified in `logging.basicConfig()`, which is `'myapp.log'` in this case. The log level is set to `DEBUG`, so all log messages with severity level `DEBUG` and above will be recorded in the log file. Any errors or issues encountered during the process will be logged as well.

